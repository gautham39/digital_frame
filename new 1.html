<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spectra 6 Frame</title>
    <style>
        /* --- MOBILE OPTIMIZED THEME --- */
        :root { 
            --primary: #2196F3; 
            --bg: #F5F7FA; 
            --card: #FFFFFF; 
            --text: #263238; 
            --border: #ECEFF1;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            padding: 16px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            margin: 0; 
            min-height: 100vh;
        }

        h1 { 
            color: #1565C0; 
            font-size: 20px; 
            margin: 10px 0 20px 0; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            text-align: center;
        }

        .container { 
            width: 100%; 
            max-width: 420px; 
        }

        .card { 
            background: var(--card); 
            padding: 20px; 
            border-radius: 16px; 
            box-shadow: 0 2px 12px rgba(0,0,0,0.06); 
            margin-bottom: 16px; 
            border: 1px solid var(--border);
        }

        .card h3 { 
            margin: 0 0 15px 0; 
            font-size: 15px; 
            color: var(--primary); 
            text-transform: uppercase;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* --- TOUCH BUTTONS --- */
        button { 
            background: var(--primary); 
            color: white; 
            border: none; 
            padding: 16px; 
            border-radius: 12px; 
            font-size: 16px; 
            font-weight: 600; 
            width: 100%; 
            cursor: pointer; 
            transition: transform 0.1s, background 0.2s; 
            -webkit-tap-highlight-color: transparent;
            box-shadow: 0 4px 10px rgba(33, 150, 243, 0.2);
        }
        button:active { transform: scale(0.98); }
        button:disabled { background: #CFD8DC; box-shadow: none; cursor: not-allowed; opacity: 0.7; }

        /* --- PREVIEW CANVAS (SMOOTH) --- */
        canvas { 
            width: 100%; 
            height: auto;
            border-radius: 8px; 
            border: 2px solid var(--border); 
            margin-top: 15px; 
            /* Fixed: Use 'auto' to let browser smooth the preview */
            image-rendering: auto; 
            background: #fafafa;
        }

        /* --- STATS & LOGS --- */
        #statsBox { background: #E3F2FD; border-radius: 12px; padding: 15px; margin-top: 15px; display: none; }
        .stat-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 6px; }
        .stat-label { color: #546E7A; }
        .stat-val { font-weight: 700; color: #1565C0; }

        .progress-bar { height: 8px; background: #ECEFF1; border-radius: 4px; margin-top: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.1s linear; }

        #debugLog { font-family: monospace; font-size: 11px; color: #90A4AE; margin-top: 20px; text-align: center; width: 100%; white-space: pre-wrap; }
        .status-badge { font-size: 12px; padding: 4px 8px; border-radius: 12px; background: #ECEFF1; color: #78909C; font-weight: normal; }
    </style>
</head>
<body>

<div class="container">
    <h1>Spectra 6 Frame</h1>

    <div class="card">
        <h3>1. Connection <span id="btBadge" class="status-badge">Disconnected</span></h3>
        <button id="btnConnect">Connect via Bluetooth</button>
    </div>

    <div class="card">
        <h3>2. Select Photo</h3>
        <input type="file" id="fileInput" accept="image/*" style="display:none">
        
        <button onclick="document.getElementById('fileInput').click()">
            Tap to Choose Image
        </button>
        
        <canvas id="previewCanvas" width="800" height="480"></canvas>
        <div style="font-size:11px; color:#90A4AE; text-align:center; margin-top:8px;">
            Sat +25% • Cont +20% • Sharp +20%
        </div>
    </div>

    <div class="card">
        <h3>3. Upload</h3>
        <button id="btnUpload" disabled>Start Upload</button>
        
        <div class="progress-bar">
            <div id="progressBar" class="progress-fill"></div>
        </div>

        <div id="statsBox">
            <div class="stat-row"><span class="stat-label">Size:</span> <span id="statSize" class="stat-val">0 KB</span></div>
            <div class="stat-row"><span class="stat-label">Time:</span> <span id="statTime" class="stat-val">0s</span></div>
            <div class="stat-row"><span class="stat-label">Speed:</span> <span id="statSpeed" class="stat-val">0 KB/s</span></div>
        </div>
    </div>

    <div id="debugLog">Ready.</div>
</div>

<script>
    // --- CONFIG ---
    const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
    const CHAR_UUID    = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
    const WIDTH = 800;
    const HEIGHT = 480;

    // --- REQUESTED PARAMETERS ---
    const SATURATION_BOOST = 1.25; // +25%
    const CONTRAST_BOOST   = 1.7; // +20%
    const SHARPEN_MIX      = 0.20; // +20%

    let device, characteristic, finalBytes;
    const log = (msg) => document.getElementById('debugLog').innerText = msg;

    // --- 1. CONNECT ---
    document.getElementById('btnConnect').onclick = async () => {
        try {
            log("Scanning...");
            device = await navigator.bluetooth.requestDevice({
                filters: [{ services: [SERVICE_UUID] }]
            });
            
            log("Connecting...");
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(SERVICE_UUID);
            characteristic = await service.getCharacteristic(CHAR_UUID);
            
            const badge = document.getElementById('btBadge');
            badge.innerText = "Connected";
            badge.style.background = "#E8F5E9";
            badge.style.color = "#2E7D32";
            
            document.getElementById('btnConnect').style.display = "none";
            
            if (finalBytes) document.getElementById('btnUpload').disabled = false;
            log("Connected. Select an image.");
        } catch (err) {
            log("Connection Failed: " + err);
        }
    };

    // --- 2. IMAGE PIPELINE ---
    document.getElementById('fileInput').onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        log("Processing...");
        const img = new Image();
        img.src = URL.createObjectURL(file);
        
        img.onload = () => {
            const cvs = document.getElementById('previewCanvas');
            const ctx = cvs.getContext('2d', { willReadFrequently: true });
            
            // High Quality Resize
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, WIDTH, HEIGHT);
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            
            const scale = Math.max(WIDTH / img.width, HEIGHT / img.height);
            const x = (WIDTH - img.width * scale) / 2;
            const y = (HEIGHT - img.height * scale) / 2;
            ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
            
            // Async Process
            setTimeout(() => {
                const result = processImage(ctx);
                finalBytes = result.bytes;
                ctx.putImageData(result.imageData, 0, 0);
                
                if (device && device.gatt.connected) document.getElementById('btnUpload').disabled = false;
                log(`Ready: ${(finalBytes.length/1024).toFixed(1)} KB`);
            }, 50);
        };
    };

    function processImage(ctx) {
        let imgData = ctx.getImageData(0, 0, WIDTH, HEIGHT);
        // 1. Adjust Colors
        imgData = applyAdjustments(imgData);
        // 2. Sharpen
        imgData = applySharpen(imgData);
        // 3. Float Dither (Best Quality)
        return applyDithering(imgData);
    }

    // --- FILTERS ---
    function applyAdjustments(imgData) {
        const d = imgData.data;
        const intercept = 128 * (1 - CONTRAST_BOOST);
        for (let i = 0; i < d.length; i += 4) {
            let r = d[i] * CONTRAST_BOOST + intercept;
            let g = d[i+1] * CONTRAST_BOOST + intercept;
            let b = d[i+2] * CONTRAST_BOOST + intercept;
            
            const gray = 0.2126 * r + 0.7152 * g + 0.0722 * b;
            r = gray + (r - gray) * SATURATION_BOOST;
            g = gray + (g - gray) * SATURATION_BOOST;
            b = gray + (b - gray) * SATURATION_BOOST;

            d[i] = Math.min(255, Math.max(0, r)); 
            d[i+1] = Math.min(255, Math.max(0, g)); 
            d[i+2] = Math.min(255, Math.max(0, b));
        }
        return imgData;
    }

    function applySharpen(imgData) {
        const w = WIDTH, h = HEIGHT;
        const d = imgData.data;
        const out = new Uint8ClampedArray(d);
        for (let y = 1; y < h - 1; y++) {
            for (let x = 1; x < w - 1; x++) {
                const i = (y * w + x) * 4;
                for (let c = 0; c < 3; c++) {
                    const val = d[i+c] * 5 - d[i+c-4] - d[i+c+4] - d[i+c-(w*4)] - d[i+c+(w*4)];
                    out[i+c] = Math.min(255, Math.max(0, d[i+c] + (val - d[i+c]) * SHARPEN_MIX));
                }
                out[i+3] = 255;
            }
        }
        return new ImageData(out, w, h);
    }

    // --- 7-COLOR FLOAT DITHER (Standard & Clean) ---
    function applyDithering(imgData) {
        const w = WIDTH, h = HEIGHT;
        const outBytes = new Uint8Array(w * h);
        const buffer = new Float32Array(imgData.data); 

        const PALETTE = [
            [0,0,0],       // 0: Black
            [255,255,255], // 1: White
            [0,255,0],     // 2: Green
            [0,0,255],     // 3: Blue
            [255,0,0],     // 4: Red
            [255,255,0],   // 5: Yellow
            [255,165,0]    // 6: Orange
        ];

        for (let y = 0; y < h; y++) {
            for (let x = 0; x < w; x++) {
                const i = (y * w + x) * 4;
                const oldR = buffer[i], oldG = buffer[i+1], oldB = buffer[i+2];

                let bestIdx = 0, minDist = Infinity;
                for (let p = 0; p < PALETTE.length; p++) {
                    const dist = Math.sqrt((oldR - PALETTE[p][0])**2 + (oldG - PALETTE[p][1])**2 + (oldB - PALETTE[p][2])**2);
                    if (dist < minDist) { minDist = dist; bestIdx = p; }
                }

                const newR = PALETTE[bestIdx][0];
                const newG = PALETTE[bestIdx][1];
                const newB = PALETTE[bestIdx][2];
                imgData.data[i] = newR; imgData.data[i+1] = newG; imgData.data[i+2] = newB;
                outBytes[y * w + x] = bestIdx;

                const errR = oldR - newR, errG = oldG - newG, errB = oldB - newB;
                const push = (dx, dy, f) => {
                    const ni = ((y + dy) * w + (x + dx)) * 4;
                    if (x + dx >= 0 && x + dx < w && y + dy < h) {
                        buffer[ni] += errR * f / 16; 
                        buffer[ni+1] += errG * f / 16; 
                        buffer[ni+2] += errB * f / 16;
                    }
                };
                push(1, 0, 7); push(-1, 1, 3); push(0, 1, 5); push(1, 1, 1);
            }
        }
        return { imageData: imgData, bytes: outBytes };
    }

    // --- 3. UPLOAD ---
    document.getElementById('btnUpload').onclick = async () => {
        if (!finalBytes || !characteristic) return;
        
        const btn = document.getElementById('btnUpload');
        btn.disabled = true;
        document.getElementById('statsBox').style.display = "none";
        log("Uploading...");
        
        try {
            const startT = Date.now();
            await characteristic.writeValue(new TextEncoder().encode("START"));
            
            const CHUNK = 512;
            let offset = 0;
            let packetCount = 0;

            while(offset < finalBytes.length) {
                const end = Math.min(offset + CHUNK, finalBytes.length);
                const chunk = finalBytes.slice(offset, end);
                
                if (packetCount % 6 === 0) {
                    await characteristic.writeValueWithResponse(chunk);
                } else {
                    await characteristic.writeValueWithoutResponse(chunk);
                }
                
                offset += CHUNK;
                packetCount++;

                if (packetCount % 5 === 0) {
                    const pct = Math.floor((offset / finalBytes.length) * 100);
                    document.getElementById('progressBar').style.width = pct + "%";
                }
            }

            await characteristic.writeValue(new TextEncoder().encode("END"));
            
            const duration = (Date.now() - startT) / 1000;
            const sizeKB = finalBytes.length / 1024;
            const speed = sizeKB / duration;

            document.getElementById('statSize').innerText = sizeKB.toFixed(1) + " KB";
            document.getElementById('statTime').innerText = duration.toFixed(1) + "s";
            document.getElementById('statSpeed').innerText = speed.toFixed(1) + " KB/s";
            document.getElementById('statsBox').style.display = "block";
            
            log("Upload Complete.");
            alert("Success! The frame is now refreshing.");

        } catch (err) {
            log("Error: " + err);
            btn.disabled = false;
        }
    };
</script>
</body>
</html>